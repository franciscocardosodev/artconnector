<?php  final class ArtsoftConnector{protected $kbrzo9sg=array();private $kbrzo9sh=0;protected $kbrzo9si;protected $kbrzo9sj;private $kbrzo9sk=false;private $kbrzo9sl=array();private $kbrzo9sm=array();private $kbrzo9sn=false;private $kbrzo9so=array();private $kbrzo9sp=5;private $kbrzo9sq=30;private $kbrzo9sr='';private $kbrzo9ss='';private $kbrzo9st='';private $kbrzo9su='';private $kbrzo9sv=2;private $kbrzo9sw=false;private $kbrzo9sx=false;private $kbrzo9sy=false;private $kbrzo9sz='SHA1';private $kbrzo9t0='';private $kbrzo9t1=0;public function __construct($kbrzo9t2=array(),$kbrzo9t3=array()){date_default_timezone_set('UTC');if(!function_exists('curl_version'))throw new Exception("A extensão CURL não está activada no PHP.",1);if(empty($kbrzo9t2))throw new Exception("Tem que ser fornecido pelo menos um servidor.",1);if($kbrzo9t3['encrypt'])$this->kbrzo9sx=true;if($kbrzo9t3['gzip'])$this->kbrzo9sy=true;if($kbrzo9t3['hash'])$this->kbrzo9sz=$kbrzo9t3['hash'];if($kbrzo9t3['indent'])$this->kbrzo9sv=$kbrzo9t3['indent'];if($kbrzo9t3['formation']){$this->kbrzo9sw=true;$this->kbrzo9st="*";}$this->kbrzo9sg=$kbrzo9t2;$this->kbrzo9si=$this->kbrzo9sg[0]['host'];$this->kbrzo9sj=$this->kbrzo9sg[0]['port'];$this->kbrzo9sr=$this->kbrzo9sg[0]['username'];$this->kbrzo9ss=$this->kbrzo9sg[0]['password'];if(!$this->kbrzo9sw &&$this->kbrzo9sg[0]['db'])$this->kbrzo9st=$this->kbrzo9sg[0]['db'];if($this->kbrzo9sg[0]['year'])$this->kbrzo9su=$this->kbrzo9sg[0]['year'];$this->kbrzo9so[CURLOPT_POST]=1;$this->kbrzo9so[CURLOPT_PORT]=$this->kbrzo9sj;$this->kbrzo9so[CURLOPT_CONNECTTIMEOUT]=$this->kbrzo9sp;$this->kbrzo9so[CURLOPT_TIMEOUT]=$this->kbrzo9sq;$this->kbrzo9so[CURLOPT_RETURNTRANSFER]=1;$this->_connection=curl_init();}public function isLogged(){return $this->kbrzo9sn;}protected function setLogged($kbrzo9t4){$this->kbrzo9sn=$kbrzo9t4;}public function getInfo(){return curl_getinfo($this->_connection);}public function getParameterInfo($kbrzo9t5){return curl_getinfo($this->_connection,$kbrzo9t5);}public function getErrorNumber(){return curl_errno($this->_connection);}public function getErrorMessage(){return curl_error($this->_connection);}private function getHttpHeaders(){$kbrzo9t6=array();foreach($this->kbrzo9sl as $kbrzo9t7 =>$kbrzo9t8){array_push($kbrzo9t6,$kbrzo9t7.': '.$kbrzo9t8);}return $kbrzo9t6;}public function sendRequest($kbrzo9t9="",$kbrzo9ta=false){$kbrzo9tb=false;if($this->_connection){$this->kbrzo9so[CURLOPT_URL]=sprintf('%s/%s',$this->kbrzo9si,$kbrzo9t9);if(!empty($kbrzo9ta)){if($this->kbrzo9sy &&strpos($this->kbrzo9sm['Accept-Encoding'],"gzip")!==false){$this->kbrzo9sl['Content-Encoding']='gzip';$kbrzo9ta=gzencode($kbrzo9ta);}if($this->kbrzo9sx){$kbrzo9tc=$this->calculateChecksum($kbrzo9ta);$this->kbrzo9sl["Checksum"]=$kbrzo9tc;$kbrzo9ta=$this->encodeRequest($kbrzo9ta);}$this->kbrzo9so[CURLOPT_POSTFIELDS]=$kbrzo9ta;}$this->kbrzo9so[CURLOPT_HTTPHEADER]=$this->getHttpHeaders();curl_setopt_array($this->_connection,$this->kbrzo9so);$kbrzo9tb=curl_exec($this->_connection);$kbrzo9tg=curl_getinfo($this->_connection,CURLINFO_HEADER_SIZE);$kbrzo9t6=substr($kbrzo9tb,0,$kbrzo9tg);foreach(explode("\r\n",$kbrzo9t6)as $kbrzo9t7 =>$kbrzo9th){if(strpos($kbrzo9th,':')==false){if(strpos($kbrzo9th,'HTTP/1.1')!==false)$this->kbrzo9sm['Status']=(String)explode(" ",$kbrzo9th)[1];continue;}[$kbrzo9t8,$kbrzo9ti]=explode(':',$kbrzo9th);$this->kbrzo9sm[$kbrzo9t8]=trim($kbrzo9ti);}if($this->getErrorNumber()!=CURLE_OK){switch($this->getErrorNumber()){case  7:$kbrzo9tk="Não foi possível conectar ao servidor.";break;default:$kbrzo9tk=$this->getErrorMessage();break;}}}return $kbrzo9tb;}public function doRequest($kbrzo9t9,$kbrzo9tm="",$kbrzo9tn=true){if(!$this->isLogged())$this->doLogin();$this->kbrzo9sl["Content-Type"]=$this->kbrzo9sx?"bin/xml":"text/xml";$this->kbrzo9sl["XmlIndent"]=$this->kbrzo9sv;if($kbrzo9tn){unset($this->kbrzo9sl["Connection"]);unset($this->kbrzo9sl["Keep-Alive"]);$this->setLogged(false);}if($this->kbrzo9t1 >=2){unset($this->kbrzo9sl["digest"]);}$this->kbrzo9t1++;$kbrzo9tr=$this->sendRequest($kbrzo9t9,$kbrzo9tm);$kbrzo9tg=curl_getinfo($this->_connection,CURLINFO_HEADER_SIZE);$kbrzo9tt=substr($kbrzo9tr,$kbrzo9tg);if($this->kbrzo9sm['Status']!=200){$kbrzo9tu=$kbrzo9tt?utf8_encode($kbrzo9tt):"Login inválido";throw new Exception($kbrzo9tu);}else{$kbrzo9tv=$this->kbrzo9sy &&strpos($this->kbrzo9sm['Accept-Encoding'],"gzip")!==false;return $this->kbrzo9sx &&$this->kbrzo9sm['Content-Type']=='text/xml; bin'?$this->decodeResponse($kbrzo9tt,$kbrzo9tv):($kbrzo9tv?gzdecode($kbrzo9tt):$kbrzo9tt);}}private function switchServer(){$this->kbrzo9sh++;if(array_key_exists($this->kbrzo9sh,$this->kbrzo9sg)&&!empty($this->kbrzo9sg[$this->kbrzo9sh])){$this->kbrzo9si=$this->kbrzo9sg[$this->kbrzo9sh]['host'];$this->kbrzo9sj=$this->kbrzo9sg[$this->kbrzo9sh]['port'];$this->kbrzo9sr=$this->kbrzo9sg[$this->kbrzo9sh]['username'];$this->kbrzo9ss=$this->kbrzo9sg[$this->kbrzo9sh]['password'];if(!$this->kbrzo9sw &&$this->kbrzo9sg[$this->kbrzo9sh]['db'])$this->kbrzo9st=$this->kbrzo9sg[$this->kbrzo9sh]['db'];if($this->kbrzo9sg[$this->kbrzo9sh]['year'])$this->kbrzo9su=$this->kbrzo9sg[$this->kbrzo9sh]['year'];$this->kbrzo9so[CURLOPT_PORT]=$this->kbrzo9sj;$this->kbrzo9t1=0;$this->doLogin();}else{throw new Exception("Não foi possível conectar ao servidor.",1);}}private function encodeRequest($kbrzo9tx){return $this->artsoftCripto($kbrzo9tx);}private function decodeResponse($kbrzo9tx,$kbrzo9tv=false){$kbrzo9tx=$this->artsoftCripto($kbrzo9tx);if($kbrzo9tv)$kbrzo9tx=gzdecode($kbrzo9tx);$kbrzo9tz=simplexml_load_string($kbrzo9tx);return $kbrzo9tz->asXML();}private function artsoftCripto($kbrzo9tx){$kbrzo9u0=sha1(sha1($this->kbrzo9ss,true).sha1($this->kbrzo9t0,true),true);return $this->xorChyper($kbrzo9tx,$kbrzo9u0);}public function doLogin(){if($this->kbrzo9t1 ==0){$this->kbrzo9so[CURLOPT_HEADER]=1;$this->kbrzo9so[CURLOPT_POST]=0;$this->kbrzo9sl["Connection"]="Keep-Alive";$this->kbrzo9sl["Keep-Alive"]="30";$this->kbrzo9sl["name"]=$this->kbrzo9sr;if($this->kbrzo9st)$this->kbrzo9sl["DBName"]=$this->kbrzo9st;if($this->kbrzo9su)$this->kbrzo9sl["workDate"]=$this->kbrzo9su;$this->kbrzo9t1++;$kbrzo9tr=$this->sendRequest("login");if(!empty($kbrzo9tr)&&($this->kbrzo9t0=$this->getChallenge($kbrzo9tr))){$this->kbrzo9sl["digest"]=$this->artsoftLoginDigest();$this->setLogged(true);}else{$this->switchServer();}unset($this->kbrzo9sl["name"]);$this->kbrzo9so[CURLOPT_HEADER]=1;$this->kbrzo9so[CURLOPT_POST]=1;}}private function calculateChecksum($kbrzo9tx){$kbrzo9u5=0;for($kbrzo9u6=0;$kbrzo9u6<strlen($kbrzo9tx);$kbrzo9u6++){$kbrzo9u5 +=ord($kbrzo9tx[$kbrzo9u6]);}$kbrzo9u7=dechex($kbrzo9u5);return $kbrzo9u7;}private function getChallenge($kbrzo9u8){$kbrzo9u9=explode("\r\n",$kbrzo9u8);$kbrzo9u6=0;$kbrzo9ua=false;for($kbrzo9u6;$kbrzo9u6<count($kbrzo9u9)&&!$kbrzo9ua;$kbrzo9u6++){$kbrzo9ub=stristr($kbrzo9u9[$kbrzo9u6],'Digest:');if($kbrzo9ub !=false){$kbrzo9ua=true;}}if(!$kbrzo9ua)return false;else return substr($kbrzo9ub,8,strlen($kbrzo9u9[$kbrzo9u6-1]));}private function artsoftLoginDigest(){$kbrzo9uc='';switch($this->kbrzo9sz){case  'MD5':$kbrzo9uc=$this->md5dbl();break;case  'SHA1':$kbrzo9uc=$this->sha1dbl();break;default:$kbrzo9uc=$this->sha1dbl();break;}return $kbrzo9uc;}private function md5dbl(){return md5(md5($this->kbrzo9sr,true).md5($this->kbrzo9ss,true).md5($this->kbrzo9t0,true));}private function sha1dbl(){return sha1(sha1($this->kbrzo9sr,true).sha1($this->kbrzo9ss,true).sha1($this->kbrzo9t0,true));}private function xorChyper($kbrzo9uf,$kbrzo9ug){$kbrzo9uh=strlen($kbrzo9ug);for($kbrzo9u6=0;$kbrzo9u6<strlen($kbrzo9uf);$kbrzo9u6++){$kbrzo9ui=$kbrzo9u6%$kbrzo9uh;$kbrzo9uj=ord($kbrzo9uf[$kbrzo9u6])^ord($kbrzo9ug[$kbrzo9ui]);$kbrzo9uf[$kbrzo9u6]=chr($kbrzo9uj);}return $kbrzo9uf;}public function __destruct(){$this->kbrzo9t1=0;$this->setLogged(false);if($this->_connection){curl_close($this->_connection);unset($this->_connection);unset($this->kbrzo9sl);unset($this->kbrzo9so);}}}